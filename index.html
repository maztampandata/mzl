<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proxy List by Country</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.3.2/css/flag-icons.min.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #F1FAFF, #CBE4FF);
      color: #333;
      margin: 0;
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #151A2D;
      margin-bottom: 20px;
      text-align: center;
      font-size: 2rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }
    .proxy-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .proxy-table th, .proxy-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .proxy-table th {
      background: linear-gradient(180deg, #151A2D, #2C3E50);
      color: white;
      font-weight: 500;
    }
    .proxy-table tr:hover {
      background-color: #f8f9fa;
    }
    .proxy-table tr:nth-child(even) {
      background-color: #fafafa;
    }
    .flag {
      font-size: 1.5em;
      margin-right: 10px;
    }
    .ping-status {
      padding: 5px 10px;
      border-radius: 15px;
      color: white;
      font-size: 0.8em;
      font-weight: bold;
      display: inline-block;
    }
    .ping-unknown {
      background-color: #6c757d;
    }
    .ping-good {
      background: linear-gradient(135deg, #28a745, #20c997);
    }
    .ping-fair {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
      color: #000;
    }
    .ping-poor {
      background: linear-gradient(135deg, #dc3545, #e83e8c);
    }
    .config-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .config-dropdown {
      position: relative;
      display: inline-block;
    }
    .config-btn {
      padding: 5px 10px;
      background: linear-gradient(135deg, #151A2D, #3a7bd5);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.2s ease;
      min-width: 120px;
    }
    .config-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    /* Specific styles for different config types */
    .config-dropdown:nth-child(1) .config-btn {
      background: linear-gradient(135deg, #151A2D, #3a7bd5);
    }
    .config-dropdown:nth-child(2) .config-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 5px;
      top: 100%;
      left: 0;
      margin-top: 5px;
    }
    .dropdown-content.show {
      display: block;
    }
    .dropdown-option {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      border: none;
      width: 100%;
      text-align: left;
      background: none;
      cursor: pointer;
      font-size: 0.8em;
      transition: background-color 0.2s;
    }
    .dropdown-option:hover {
      background-color: #f1f1f1;
    }
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
      color: #6c757d;
    }
    
    .loading-animation {
      display: inline-block;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% {
        opacity: 0.5;
      }
      50% {
        opacity: 1;
      }
      100% {
        opacity: 0.5;
      }
    }
    
    .loading-dots:after {
      content: '.';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0% {
        content: '.';
      }
      33% {
        content: '..';
      }
      66% {
        content: '...';
      }
      100% {
        content: '.';
      }
    }
    .error {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1;
      background: linear-gradient(135deg, #151A2D, #2C3E50);
      color: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      min-width: 200px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .stat-card h3 {
      margin-top: 0;
      font-size: 1.2rem;
    }
    .stat-card .number {
      font-size: 2rem;
      font-weight: bold;
      margin: 10px 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .country-selector {
      margin-bottom: 20px;
    }
    .country-selector select {
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      width: 100%;
      max-width: 400px;
      background: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    .country-selector select:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .country-selector select:focus {
      outline: none;
      border-color: #4e9af1;
      box-shadow: 0 4px 15px rgba(78, 154, 241, 0.2);
    }
    .country-flag {
      margin-right: 10px;
    }
    .pagination-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      padding: 15px 0;
    }
    .pagination-btn {
      padding: 8px 15px;
      background: linear-gradient(135deg, #151A2D, #3a7bd5);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s ease;
      margin: 0 5px;
    }
    .pagination-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .pagination-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .pagination-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }
    
    /* Progress bar styles */
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }
    
    .progress-bar {
      height: 20px;
      background: linear-gradient(90deg, #4e9af1, #151A2D);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
    }
    
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 0.8rem;
      width: 100%;
      text-align: center;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        flex-direction: column;
        width: 100%;
        box-sizing: border-box;
      }
      .container {
        padding: 0 10px;
        width: 100%;
        max-width: 100%;
      }
      h1 {
        font-size: 1.7rem;
      }
      .card {
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
      }
      .stats {
        flex-direction: column;
      }
      .stat-card {
        min-width: 100%;
        padding: 15px;
        margin-bottom: 15px;
      }
      .stat-card h3 {
        font-size: 1.1rem;
      }
      .stat-card .number {
        font-size: 1.7rem;
      }
      .proxy-table th, .proxy-table td {
        padding: 10px 8px;
        font-size: 0.9rem;
      }
      .config-buttons {
        flex-direction: column;
      }
      .config-btn {
        width: 100%;
        margin-bottom: 5px;
      }
      .country-selector select {
        max-width: 100%;
      }
      .pagination-container {
        flex-direction: column;
        gap: 10px;
      }
      .pagination-btn {
        width: 100%;
        margin: 5px 0;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
        margin: 0;
        width: 100%;
        box-sizing: border-box;
      }
      .container {
        padding: 0;
        width: 100%;
        max-width: 100%;
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        padding: 0 10px;
      }
      h2 {
        text-align: center !important;
      }
      .card {
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 10px;
      }
      .proxy-table {
        font-size: 0.85rem;
        display: block;
        overflow-x: auto;
        width: 100%;
      }
      .proxy-table th, .proxy-table td {
        padding: 8px 5px;
      }
      .stat-card {
        padding: 12px;
        margin-bottom: 15px;
      }
      .stat-card h3 {
        font-size: 1rem;
      }
      .stat-card .number {
        font-size: 1.5rem;
      }
      .ping-status {
        font-size: 0.7em;
        padding: 3px 8px;
      }
      .config-btn {
        font-size: 0.75em;
        padding: 4px 8px;
      }
      .country-selector select {
        padding: 10px 12px;
        font-size: 0.9rem;
      }
      .loading {
        padding: 20px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <i class='bx bx-server'></i> 
      SERVER CLOUDFLARE
    </h1>
    
    <div class="card">
      <h2>Select Country</h2>
      <div class="country-selector" style="display: flex; justify-content: center;">
        <select id="country-select" onchange="loadCountryProxies()" style="max-width: 400px; width: 100%;">
          <option value="">Loading countries...</option>
        </select>
      </div>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <h3>Total Proxies</h3>
        <div class="number" id="total-count">0</div>
      </div>
      <div class="stat-card">
        <h3>Loaded Proxies</h3>
        <div class="number" id="loaded-count">0</div>
      </div>
      <div class="stat-card">
        <h3>Selected Country</h3>
        <div class="number" id="selected-country">-</div>
      </div>
    </div>
    
    <div class="card">
      <h2>Proxy Servers</h2>
      <div id="proxy-list-container">
        <!-- Progress bar for loading -->
        <div class="progress-container" id="progress-container">
          <div class="progress-bar" id="progress-bar">
            <div class="progress-text" id="progress-text">0%</div>
          </div>
        </div>
        <div class="loading" id="loading">Select a country to load proxy data...</div>
        <div id="proxy-list"></div>
        <div id="pagination" class="pagination-container" style="display: none; margin-top: 20px; text-align: center;">
          <button id="prev-page" class="pagination-btn" onclick="changePage(-1)">Previous</button>
          <span id="page-info" style="margin: 0 15px;"></span>
          <button id="next-page" class="pagination-btn" onclick="changePage(1)">Next</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // PRX_BANK_URL for fetching country list
const PRX_BANK_URL = "https://raw.githubusercontent.com/maztampandata/cfproxies/refs/heads/main/backend/src/mazcheckproxy.txt";
    
    // Pagination variables
    let currentPage = 1;
    const rowsPerPage = 10;
    let currentProxyData = [];
    
    // Progress bar variables
    let progressInterval;
    
    // Country code to name mapping (add more as needed)
    const countryNames = {
      'AD': 'Andorra',
      'AE': 'United Arab Emirates',
      'AM': 'Armenia',
      'AT': 'Austria',
      'AU': 'Australia',
      'BE': 'Belgium',
      'BG': 'Bulgaria',
      'BR': 'Brazil',
      'CA': 'Canada',
      'CH': 'Switzerland',
      'CN': 'China',
      'CY': 'Cyprus',
      'CZ': 'Czech Republic',
      'DE': 'Germany',
      'DK': 'Denmark',
      'EE': 'Estonia',
      'ES': 'Spain',
      'FI': 'Finland',
      'FR': 'France',
      'GB': 'United Kingdom',
      'GE': 'Georgia',
      'GR': 'Greece',
      'HK': 'Hong Kong',
      'HR': 'Croatia',
      'HU': 'Hungary',
      'ID': 'Indonesia',
      'IE': 'Ireland',
      'IL': 'Israel',
      'IN': 'India',
      'IS': 'Iceland',
      'IT': 'Italy',
      'JP': 'Japan',
      'KR': 'South Korea',
      'KZ': 'Kazakhstan',
      'LT': 'Lithuania',
      'LU': 'Luxembourg',
      'LV': 'Latvia',
      'MD': 'Moldova',
      'MK': 'North Macedonia',
      'MT': 'Malta',
      'MX': 'Mexico',
      'MY': 'Malaysia',
      'NL': 'Netherlands',
      'NO': 'Norway',
      'NZ': 'New Zealand',
      'PH': 'Philippines',
      'PL': 'Poland',
      'PT': 'Portugal',
      'RO': 'Romania',
      'RS': 'Serbia',
      'RU': 'Russia',
      'SA': 'Saudi Arabia',
      'SE': 'Sweden',
      'SG': 'Singapore',
      'SI': 'Slovenia',
      'SK': 'Slovakia',
      'TH': 'Thailand',
      'TR': 'Turkey',
      'TW': 'Taiwan',
      'UA': 'Ukraine',
      'US': 'United States',
      'VN': 'Vietnam',
      'ZA': 'South Africa'
    };
    
    // Function to toggle dropdown visibility
    function toggleDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      dropdown.classList.toggle('show');
      
      // Close other dropdowns when opening a new one
      const allDropdowns = document.querySelectorAll('.dropdown-content');
      allDropdowns.forEach(dd => {
        if (dd.id !== dropdownId) {
          dd.classList.remove('show');
        }
      });
    }
    
    // Close dropdowns when clicking outside
    window.onclick = function(event) {
      if (!event.target.matches('.config-btn')) {
        const dropdowns = document.querySelectorAll('.dropdown-content');
        dropdowns.forEach(dropdown => {
          if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        });
      }
    }
    
    // Function to determine ping status class
    function getPingStatusClass(delay) {
  if (delay === null || delay === 0) return 'ping-poor';
  if (delay <= 50) return 'ping-good';
  if (delay <= 100) return 'ping-fair';
  return 'ping-poor';
    }
    
    // Function to determine ping status text
    function getPingStatusText(delay) {
  if (delay === undefined) return 'checking...';
  if (delay === null) return '999ms';
  return `${delay}ms`;
    }
    
    // Function to copy text to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Show SweetAlert2 success notification
        Swal.fire({
          position: 'top-end',
          icon: 'success',
          title: 'Configuration copied to clipboard!',
          showConfirmButton: false,
          timer: 1500,
          toast: true
        });
      }).catch(err => {
        console.error('Failed to copy: ', err);
        // Show SweetAlert2 error notification
        Swal.fire({
          position: 'top-end',
          icon: 'error',
          title: 'Failed to copy configuration',
          showConfirmButton: false,
          timer: 1500,
          toast: true
        });
      });
    }
    
    // Function to show notification (deprecated, but kept for compatibility)
    function showNotification(message, isError = false) {
      Swal.fire({
        position: 'top-end',
        icon: isError ? 'error' : 'success',
        title: message,
        showConfirmButton: false,
        timer: 1500,
        toast: true
      });
    }
    
    // Function to update progress bar
    function updateProgress(percent) {
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const progressContainer = document.getElementById('progress-container');
      
      if (progressBar && progressText) {
        progressBar.style.width = percent + '%';
        progressText.textContent = Math.round(percent) + '%';
        
        if (percent >= 100) {
          // Hide progress bar when complete
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 300);
        }
      }
    }
    
    // Function to start progress simulation
    function startProgress() {
      const progressContainer = document.getElementById('progress-container');
      progressContainer.style.display = 'block';
      
      let progress = 0;
      updateProgress(0);
      
      // Clear any existing interval
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      
      // Simulate progress
      progressInterval = setInterval(() => {
        // Random increment between 5-15%
        progress += Math.random() * 10 + 5;
        
        if (progress >= 90) {
          // Slow down near the end
          progress = Math.min(progress, 95);
        }
        
        updateProgress(progress);
        
        // Stop when we reach 95% (will be completed when data loads)
        if (progress >= 95) {
          clearInterval(progressInterval);
        }
      }, 200);
    }
    
    // Function to stop progress simulation
    function stopProgress() {
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      updateProgress(100);
    }
    
    // Function to render proxy list with pagination
    function renderProxyList(data) {
      // Show table immediately with ping as 'checking...'
      currentProxyData = data.map(proxy => {
        proxy.ping = { delay: undefined };
        return proxy;
      });
      currentPage = 1;
      renderProxyTable();
      renderPagination();
    }
    
    // Function to render the proxy table for the current page
    function renderProxyTable() {
      const container = document.getElementById('proxy-list');

      if (!currentProxyData || currentProxyData.length === 0) {
        container.innerHTML = '<p>No proxy data available for the selected country.</p>';
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      // Pagination
      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, currentProxyData.length);
      const pageData = currentProxyData.slice(startIndex, endIndex);

      let tableHTML = `
        <table class="proxy-table">
          <thead>
            <tr>
              <th>IP Address</th>
              <th>Port</th>
              <th>ISP</th>
              <th>Ping</th>
              <th>Configs</th>
            </tr>
          </thead>
          <tbody>
      `;

      pageData.forEach(proxy => {
        const pingStatusClass = getPingStatusClass(proxy.ping?.delay);
        const pingStatusText = getPingStatusText(proxy.ping?.delay);
        const countryCode = proxy.country?.toLowerCase?.() || '';

        // Config buttons HTML
        let configButtonsHTML = '';
        if (proxy.config_tls) {
          let tlsOptions = '';
          if (proxy.config_tls.trojan) tlsOptions += `<button class="dropdown-option" onclick="copyToClipboard('${proxy.config_tls.trojan}')">Trojan</button>`;
          if (proxy.config_tls.vless) tlsOptions += `<button class="dropdown-option" onclick="copyToClipboard('${proxy.config_tls.vless}')">VLESS</button>`;
          if (proxy.config_tls.ss) tlsOptions += `<button class="dropdown-option" onclick="copyToClipboard('${proxy.config_tls.ss}')">SS</button>`;
          configButtonsHTML += `
            <div class="config-dropdown">
              <button class="config-btn" onclick="toggleDropdown('tls-${proxy.ip}')">TLS</button>
              <div class="dropdown-content" id="tls-${proxy.ip}">${tlsOptions}</div>
            </div>`;
        }
        if (proxy.config_ntls) {
          let ntlsOptions = '';
          if (proxy.config_ntls.trojan) ntlsOptions += `<button class="dropdown-option" onclick="copyToClipboard('${proxy.config_ntls.trojan}')">Trojan</button>`;
          if (proxy.config_ntls.vless) ntlsOptions += `<button class="dropdown-option" onclick="copyToClipboard('${proxy.config_ntls.vless}')">VLESS</button>`;
          if (proxy.config_ntls.ss) ntlsOptions += `<button class="dropdown-option" onclick="copyToClipboard('${proxy.config_ntls.ss}')">SS</button>`;
          configButtonsHTML += `
            <div class="config-dropdown">
              <button class="config-btn" onclick="toggleDropdown('ntls-${proxy.ip}')">Non-TLS</button>
              <div class="dropdown-content" id="ntls-${proxy.ip}">${ntlsOptions}</div>
            </div>`;
        }

        tableHTML += `
          <tr>
            <td><span class="fi fi-${countryCode}" style="margin-right: 10px;"></span>${proxy.ip}</td>
            <td>${proxy.port}</td>
            <td>${proxy.isp || proxy.orgz || ''}</td>
            <td>
              <span class="ping-status ${pingStatusClass}" id="ping-${proxy.ip}-${proxy.port}">
                ${pingStatusText}
              </span>
            </td>
            <td>
              <div class="config-buttons">${configButtonsHTML}</div>
            </td>
          </tr>
        `;
      });

      tableHTML += `</tbody></table>`;
      container.innerHTML = tableHTML;

      // Sequential ping hanya untuk proxy yang tampil di halaman
      async function sequentialPingPage(index = 0) {
        if (index >= pageData.length) return;
        const proxy = pageData[index];
        const pingSpanId = `ping-${proxy.ip}-${proxy.port}`;
        const pingSpan = document.getElementById(pingSpanId);
        if (pingSpan) {
          pingSpan.textContent = 'checking...';
          pingSpan.className = 'ping-status ping-unknown';
          try {
            const res = await fetch(`https://check.mazlana.biz.id/api/v1?ip=${proxy.ip}&port=${proxy.port}`);
            if (res.ok) {
              const pingData = await res.json();
              let delayValue = undefined;
              // Pastikan parsing delay benar dari string "487 ms"
              if (pingData && typeof pingData.delay === "string") {
                const match = pingData.delay.match(/(\d+)/);
                if (match && match[1]) {
                  delayValue = parseInt(match[1]);
                }
              }
              // Jika delayValue valid, tampilkan ping
              if (typeof delayValue === 'number' && !isNaN(delayValue)) {
                proxy.ping = { delay: delayValue };
                pingSpan.textContent = getPingStatusText(delayValue);
                pingSpan.className = `ping-status ${getPingStatusClass(delayValue)}`;
              } else {
                // Jika parsing gagal, tetap 'checking...'
                proxy.ping = { delay: undefined };
                pingSpan.textContent = getPingStatusText(undefined);
                pingSpan.className = `ping-status ${getPingStatusClass(undefined)}`;
              }
            } else {
              pingSpan.textContent = getPingStatusText(undefined);
              pingSpan.className = `ping-status ${getPingStatusClass(undefined)}`;
            }
          } catch {
            pingSpan.textContent = getPingStatusText(undefined);
            pingSpan.className = `ping-status ${getPingStatusClass(undefined)}`;
          }
        }
        setTimeout(() => sequentialPingPage(index + 1), 200); // jeda 200ms antar ping
      }
      sequentialPingPage(0);

      let pingRealtimeInterval;
function startRealtimePing(pageData) {
  // Clear interval jika sudah ada
  if (pingRealtimeInterval) clearInterval(pingRealtimeInterval);

  pingRealtimeInterval = setInterval(() => {
    pageData.forEach(async proxy => {
      const pingSpanId = `ping-${proxy.ip}-${proxy.port}`;
      const pingSpan = document.getElementById(pingSpanId);
      if (pingSpan) {
        try {
          const res = await fetch(`https://check.mazlana.biz.id/api/v1?ip=${proxy.ip}&port=${proxy.port}`);
          if (res.ok) {
            const pingData = await res.json();
            let delayValue = undefined;
            if (pingData && typeof pingData.delay === "string") {
              const match = pingData.delay.match(/(\d+)/);
              if (match && match[1]) {
                delayValue = parseInt(match[1]);
              }
            }
            proxy.ping = { delay: delayValue };
            pingSpan.textContent = getPingStatusText(delayValue);
            pingSpan.className = `ping-status ${getPingStatusClass(delayValue)}`;
          } else {
            pingSpan.textContent = getPingStatusText(undefined);
            pingSpan.className = `ping-status ${getPingStatusClass(undefined)}`;
          }
        } catch {
          pingSpan.textContent = getPingStatusText(undefined);
          pingSpan.className = `ping-status ${getPingStatusClass(undefined)}`;
        }
      }
    });
  }, 10000); // 10 detik
}

// Di akhir renderProxyTable, setelah sequentialPingPage(0);
sequentialPingPage(0);
startRealtimePing(pageData);
    }
    
    // Function to render pagination controls
    function renderPagination() {
      if (!currentProxyData || currentProxyData.length === 0) {
        document.getElementById('pagination').style.display = 'none';
        return;
      }
      
      const totalPages = Math.ceil(currentProxyData.length / rowsPerPage);
      
      if (totalPages <= 1) {
        document.getElementById('pagination').style.display = 'none';
        return;
      }
      
      document.getElementById('pagination').style.display = 'flex';
      
      // Update page info
      document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
      
      // Update button states
      document.getElementById('prev-page').disabled = currentPage === 1;
      document.getElementById('next-page').disabled = currentPage === totalPages;
    }
    
    // Function to change page
    function changePage(direction) {
      const totalPages = Math.ceil(currentProxyData.length / rowsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderProxyTable();
        renderPagination();
        
        // Scroll to top of table
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
      }
    }
    
    // Function to get unique countries from proxy data
    function getUniqueCountries(proxyData) {
      const countries = new Set();
      const lines = proxyData.split('\n');
      
      lines.forEach(line => {
        const parts = line.split(',');
        if (parts.length >= 4) {
          const countryCode = parts[2].trim();
          if (countryCode) {
            countries.add(countryCode);
          }
        }
      });
      
      return Array.from(countries).sort();
    }
    
    // Function to count total proxies in KV URL
    async function countTotalProxies() {
      try {
        const response = await fetch(PRX_BANK_URL);
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim() !== '');
        const totalCount = lines.length;
        
        // Update the Total Proxies count display
        document.getElementById('total-count').textContent = totalCount;
        
        return totalCount;
      } catch (error) {
        console.error('Error counting total proxies:', error);
        document.getElementById('total-count').textContent = 'Error';
        return 0;
      }
    }
    
    // Function to fetch country list
    async function fetchCountryList() {
      const countrySelect = document.getElementById('country-select');
      
      try {
        const response = await fetch(PRX_BANK_URL);
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const text = await response.text();
        const uniqueCountries = getUniqueCountries(text);
        
        // Clear the select and add default option
        countrySelect.innerHTML = '<option value="">-- Select a Country --</option>';
        
        // Add countries to the select with names and flags
        uniqueCountries.forEach(countryCode => {
          const countryName = countryNames[countryCode] || countryCode;
          const option = document.createElement('option');
          option.value = countryCode;
          option.textContent = countryName;
          countrySelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error fetching country list:', error);
        countrySelect.innerHTML = '<option value="">Failed to load countries</option>';
        // Show SweetAlert2 error notification
        Swal.fire({
          position: 'top-end',
          icon: 'error',
          title: 'Failed to load country list',
          showConfirmButton: false,
          timer: 1500,
          toast: true
        });
      }
    }
    
    // Function to fetch proxy data for a specific country
    async function loadCountryProxies() {
      const countrySelect = document.getElementById('country-select');
      const selectedCountry = countrySelect.value;
      const loadingElement = document.getElementById('loading');
      const proxyListContainer = document.getElementById('proxy-list');
      
      // Update selected country display
      if (selectedCountry) {
        const countryName = countryNames[selectedCountry] || selectedCountry;
        const lowerCountryCode = selectedCountry.toLowerCase();
        document.getElementById('selected-country').innerHTML = `<span class="fi fi-${lowerCountryCode}"></span><span style="margin-left: 10px;">${countryName}</span>`;
      } else {
        document.getElementById('selected-country').innerHTML = '-';
      }
      
      if (!selectedCountry) {
        loadingElement.innerHTML = '<span class="loading-animation">Select a country to load proxy data</span>';
        proxyListContainer.innerHTML = '';
        document.getElementById('total-count').textContent = '0';
        document.getElementById('loaded-count').textContent = '0';
        document.getElementById('pagination').style.display = 'none';
        return;
      }
      
      try {
        // Start progress bar
        startProgress();
        
        loadingElement.style.display = 'block';
        loadingElement.innerHTML = `<span class="loading-animation">Loading proxy data for ${countryNames[selectedCountry] || selectedCountry}</span><span class="loading-dots"></span>`;
        proxyListContainer.innerHTML = '';
        document.getElementById('pagination').style.display = 'none';
        
  // Fetch proxies for the selected country (new endpoint)
  const response = await fetch(`https://cosmos.mazlana.biz.id/api/v1/sub?cc=${selectedCountry}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
  const data = await response.json();

  // Stop progress bar and show completion
  stopProgress();

  // Update stats
  document.getElementById('loaded-count').textContent = data.length || 0;

  // Render proxy list with pagination
  renderProxyList(data);

  loadingElement.style.display = 'none';
      } catch (error) {
        // Stop progress bar on error
        stopProgress();
        
        loadingElement.style.display = 'none';
        proxyListContainer.innerHTML = `
          <div class="error">
            Failed to load proxy data for ${countryNames[selectedCountry] || selectedCountry}: ${error.message}
          </div>
        `;
        console.error('Error fetching proxy data:', error);
        // Show SweetAlert2 error notification
        Swal.fire({
          position: 'top-end',
          icon: 'error',
          title: `Failed to load proxy data for ${countryNames[selectedCountry] || selectedCountry}`,
          showConfirmButton: false,
          timer: 1500,
          toast: true
        });
      }
    }
    
    // Load country list when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Count total proxies in KV URL and display in Total Proxies card
      countTotalProxies();
      
      // Check if a country code is passed in the URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const countryCode = urlParams.get('cc');
      
      if (countryCode) {
        // Set the selected country in the dropdown
        fetchCountryList().then(() => {
          const countrySelect = document.getElementById('country-select');
          countrySelect.value = countryCode;
          loadCountryProxies();
        });
      } else {
        fetchCountryList();
      }
    });
  </script>
</body>
</html>
